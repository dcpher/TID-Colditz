(function(d){d.fn.extend({autocomplete:function(i,c){var c=d.extend({loadingClass:"loading",selectedClass:"selected",selectableClass:"selectable",groupTitleClass:"group-title",autocompleterClass:"autocomplete",maxItems:10,selectFirstItem:true,enableExactMatching:true,typingTimeOut:0,fadeInSpeed:200,alignment:"left",getUrlParameters:{},topOffset:0,leftOffset:0,exactMatchSeperatorRegex:/\s*(?:,|\s&\s|\sand\s)\s*/i,instructions:d("<div>Start typing to find matches</div>"),groupingTitle:function(){return null},
inputFilter:function(a){return a},autocompleterTemplate:function(a){return a},matchTemplate:function(a,b,c){return c(b,a)},matchFromLocal:function(a,b,c){var g=[],h=a.toLowerCase();d.each(b,function(a,b){b=b.toLowerCase();(c?b==h:b.indexOf(h)!=-1)&&g.push(b)});return g},insertAbsoluteElement:function(a,b,d){var g=a.outerWidth()+"px",h=a.offset().top+a.outerHeight(true)+c.topOffset,f=a.offset().left+c.leftOffset;b.css({position:"absolute",top:h+"px",left:f+"px",width:d?g:null}).appendTo("body");c.alignment==
"right"&&b.css("left",a.offset().left+a.outerWidth()-b.outerWidth()+c.leftOffset+"px")}},c),j=function(a,b){var c=d.trim(a).replace(/([\\\^\$*+[\]?{}.=!:(|)])/g,"\\$1");return c.length==0?b:b.replace(RegExp(c,"gi"),function(a){return"<em>"+a+"</em>"})};return this.each(function(){var a=d(this).bind("init.autocomplete",function(){a.attr("autocomplete","off");a.trigger("addClickOutsideListener.autocomplete")}).bind("keydown.autocomplete",function(b){var c=true;switch(b.keyCode){case 27:a.data("typingTimeOut")&&
clearInterval(a.data("typingTimeOut"));a.trigger("removeAutocompleter");a.trigger("removeInstructions");break;case 13:c=false;a.trigger("triggerUseSelectedOrFindMatch");break;case 9:a.trigger("triggerUseSelectedOrFindMatch");a.trigger("removeInstructions");a.trigger("removeAutocompleter");break;case 40:a.trigger("selectNext");break;case 38:a.trigger("selectPrevious");break;default:return}a.data("supressKey",true);return c}).bind("keyup.autocomplete",function(b){if(a.data("supressKey"))a.data("supressKey",
false);else if(b=b.keyCode,b>=48||b==46||b==8)a.data("typingTimeOut")&&clearInterval(a.data("typingTimeOut")),a.data("typingTimeOut",setTimeout(function(){a.trigger("findMatches")},c.typingTimeOut))}).bind("triggerUseSelectedOrFindMatch",function(){a.data("autocompleter")&&a.data("autocompleter").find("."+c.selectedClass).length>0?a.trigger("useSelectedItem"):c.enableExactMatching&&a.trigger("findExactMatches")}).bind("focus.autocomplete",function(){c.inputFilter(d.trim(a.val())).length==0&&a.trigger("showInstructions")}).bind("findMatches",
function(){var b=c.inputFilter(d.trim(a.val()));if(b!="")if(a.trigger("removeInstructions"),d.type(i)=="array"){var e=c.matchFromLocal(b,i).slice(0,c.maxItems);e.length>0?a.trigger("showMatches",[e,b]):a.trigger("removeAutocompleter")}else a.addClass(c.loadingClass),d.getJSON(i,d.extend(c.getUrlParameters,{text:b}),function(d){a.removeClass(c.loadingClass);d.matches.length>0?a.trigger("showMatches",[d.matches,b]):a.trigger("removeAutocompleter")});else a.trigger("removeAutocompleter"),a.trigger("showInstructions")}).bind("findExactMatches",
function(){var b=c.inputFilter(d.trim(a.val()));if(b!="")if(a.trigger("removeInstructions"),d.type(i)=="array"){var e=b.split(c.exactMatchSeperatorRegex),g=[];d.each(e,function(d,f){var e=c.matchFromLocal(f,i,true);e.length>0?a.trigger("itemChosen",[e[0],b]):g.push(f)});g.length>0&&a.trigger("errorFeedback.autocomplete",["failed on exact match",g])}else a.addClass(c.loadingClass),d.getJSON(i,d.extend(c.getUrlParameters,{text:b,exact:true}),function(e){a.removeClass(c.loadingClass);d.each(e.matches,
function(c,d){a.trigger("itemChosen",[d,b])});e.failed.length>0&&a.trigger("errorFeedback.autocomplete",["failed on exact match",e.failed])});a.trigger("removeAutocompleter")}).bind("showInstructions",function(){if(!a.data("instructions")){var b=c.instructions.hide();c.insertAbsoluteElement(a,b);b.fadeIn(c.fadeInSpeed);a.data("instructions",b);a.trigger("instructionsShown",[b])}}).bind("showMatches",function(b,e,g){var h,f=d("<ul/>").addClass(c.autocompleterClass).data("textUserEntered",g);d.each(e,
function(a,b){var e=c.groupingTitle(b);e&&e!=h&&(h=e,d("<li/>").addClass(c.groupTitleClass).html(e).appendTo(f));d("<li/>").html(c.matchTemplate(b,g,j)).addClass(a%2?"even":"odd").addClass(c.selectableClass).data("dataObject",b).appendTo(f)});f=c.autocompleterTemplate(f);a.trigger("removeAutocompleter");c.insertAbsoluteElement(a,f,true);a.data("autocompleter",f);a.trigger("addSelectionListeners.autocomplete");c.selectFirstItem&&a.trigger("selectNext");a.trigger("autocompleterShown",[f])}).bind("addClickOutsideListener.autocomplete",
function(){d(document).bind("click.autocomplete",function(b){a.data("autocompleter")&&!d(b.target).is(a)&&d(b.target).closest(a.data("autocompleter")).length==0&&a.trigger("removeAutocompleter");a.data("instructions")&&!d(b.target).is(a)&&d(b.target).closest(a.data("instructions")).length==0&&a.trigger("removeInstructions")})}).bind("addSelectionListeners.autocomplete",function(){a.data("autocompleter").bind("click.autocomplete",function(b){d(b.target).closest("li."+c.selectableClass)[0]&&(a.data("supressKey",
false),a.trigger("useSelectedItem"))}).bind("mouseover.autocomplete",function(a){a=d(a.target).closest("li."+c.selectableClass);a[0]&&!a.hasClass(c.selectedClass)&&a.addClass(c.selectedClass).siblings().removeClass(c.selectedClass)})}).bind("selectNext",function(){if(a.data("autocompleter")){var b="ul."+c.autocompleterClass,b=a.data("autocompleter").is(b)?a.data("autocompleter"):a.data("autocompleter").find(b),d=b.children("."+c.selectedClass).next("."+c.selectableClass),b=d.length==1?d:b.children("."+
c.selectableClass+":first");b.addClass(c.selectedClass).siblings().removeClass(c.selectedClass);a.trigger("nextSelected",[b])}}).bind("selectPrevious",function(){if(a.data("autocompleter")){var b="ul."+c.autocompleterClass,b=a.data("autocompleter").is(b)?a.data("autocompleter"):a.data("autocompleter").find(b),d=b.children("."+c.selectedClass).prev("."+c.selectableClass),b=d.length==1?d:b.children("."+c.selectableClass+":last");b.addClass(c.selectedClass).siblings().removeClass(c.selectedClass);a.trigger("previousSelected",
[b])}}).bind("useSelectedItem",function(){var b=a.data("autocompleter").find("."+c.selectedClass);a.trigger("itemChosen",[b.data("dataObject"),a.data("autocompleter").data("textUserEntered"),b]);a.trigger("removeAutocompleter")}).bind("removeAutocompleter",function(){a.data("autocompleter")&&(a.data("autocompleter").remove(),a.data("autocompleter",null))}).bind("removeInstructions",function(){a.data("instructions")&&(a.data("instructions").remove(),a.data("instructions",null))});a.trigger("init.autocomplete")})}})})(jQuery);